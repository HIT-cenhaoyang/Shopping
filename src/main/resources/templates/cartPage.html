<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Your Cart</title>
    <link rel="stylesheet" th:href="@{/styles/homepagestyle.css}" />
	<style>
		/* Cover image styling */
		.cover-image-container {
		    flex: 1;
		    max-width: 50%;
		    margin-right: 20px;
		    background-color: #f4f4f4;
		    display: flex;
		    justify-content: center;
		    align-items: center;
		    height: 400px; /* Set a fixed height */
		    width: auto; /* Set width to auto to maintain aspect ratio */
		}

		.cover-image-container img {
		    max-width: 100%; /* Scale the image to fit the width */
		    max-height: 100%; /* Ensure the image fits within the height */
		    object-fit: contain; /* Maintain aspect ratio and contain image */
		    border-radius: 5px;
		}
	</style>
</head>
<body>
	
	<div th:replace="fragments :: header"></div>
    <h1>Your Cart</h1>
    
    <div class="cart-container">
		<!-- class name cannot change, other javascript mappinged wrongly in updatesummay-->
        <table class="cart-details" id="cart-details">
            <!-- Cart items will be loaded here dynamically -->
        </table>


        <div class="order-summary">
            <h2>Order summary</h2>
			<!-- class name cannot change, other javascript mappinged wrongly in updatesummay-->
			<p>Products (<span id="product-count">0</span>): $<span id="product-total">0.00</span></p>
     
			<a th:href="@{/7haven/checkout}" class="btn">Check out</a> 
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
			console.log("loading")
            loadCartItems();
        });

        async function loadCartItems() {
            try {
                let response = await fetch("/api/cart/items");
                if (response.ok) {
                    let cartItems = await response.json();
                    cartItems.forEach(item => addItemToCart(item));
                } else {
                    console.error("Failed to load cart items.");
                }
            } catch (error) {
                console.error("Error fetching cart items: ", error);
            }
        }

        function addItemToCart(item) {

			console.log(item)
            const cartDetails = document.getElementById('cart-details');

            const cartItem = document.createElement('div');
            cartItem.classList.add('cart-item');
            cartItem.dataset.id = item.cartId;
            const coverImage = item.product.images && item.product.images.length > 0 ? item.product.images[0].fileName : 'default.jpg';

            cartItem.innerHTML = `
			<tr>
				<td>
				<div class="cover-image-container">
					<img src="${item.product.coverImagePath}" alt="Product Image" id="${item.product.name}">
				</div>
				</td>
				<td><h3>${item.product.name}</h3></td>

                <td>
					<p>${item.product.description}</p>
                	Price per unit: $<span class="item-price">${item.product.price.toFixed(2)}</span>
				</td>
                <td>
					<button onclick="updateQuantity(${item.cartId}, -1)">-</button>
                    <input type="number" value="${item.productQty}" min="1" onchange="updateQuantity(${item.cartId}, 0)">
                    <button onclick="updateQuantity(${item.cartId}, 1)">+</button>
                </td>
			</tr>
            `;
            cartDetails.appendChild(cartItem);
            updateSummary();
        }

        function updateQuantity(cartId, delta) {
            let itemRow = document.querySelector(`.cart-item[data-id="${cartId}"]`);
            let quantityInput = itemRow.querySelector('input[type="number"]');
            let currentQuantity = parseInt(quantityInput.value);
            let newQuantity = delta === 0 ? currentQuantity : currentQuantity + delta;

            if (newQuantity < 1) {
                removeItem(cartId);
            } else {
                quantityInput.value = newQuantity;
                updateSummary();

                fetch(`/api/cart/update/${cartId}/${newQuantity}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ quantity: newQuantity })
                }).then(response => {
                    if (!response.ok) {
                        console.error("Failed to update quantity.");
                    }
                });
            }
        }

        function removeItem(cartId) {
            let itemRow = document.querySelector(`.cart-item[data-id="${cartId}"]`);
            itemRow.remove();
            updateSummary();

            // 从购物车中删除商品
            fetch(`/api/cart/remove/${cartId}`, {
                method: 'DELETE'
            }).then(response => {
                if (!response.ok) {
                    console.error("Failed to remove item from cart.");
                }
            });
        }

        function updateSummary() {
            let totalItems = 0;
            let totalPrice = 0;
            let itemRows = document.querySelectorAll('.cart-item');

            itemRows.forEach(function(item) {
                var quantity = parseInt(item.querySelector('input[type="number"]').value);
                var priceText = item.querySelector('.item-price').textContent;
                var pricePerUnit = parseFloat(priceText.replace('$', ''));
                totalItems += quantity;
                totalPrice += pricePerUnit * quantity;
            });

            document.getElementById('product-count').textContent = totalItems;
            document.getElementById('product-total').textContent = totalPrice.toFixed(2);
        }
    </script>
</body>
</html>
