<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Checkout Page</title>
	<link rel="stylesheet" th:href="@{/styles/homepagestyle.css}" />
    <script>
        // 显示所有支付方式
        function showAllPaymentDetails() {
            document.getElementById("allPaymentDetails").style.display = "block";
            document.getElementById("showButton").style.display = "none";
        }

        // 更新选中的银行卡号
        function selectPaymentDetail(cardNumber) {
            console.log(cardNumber); // 检查是否获取到了正确的银行卡号
            // 使用掩码后的版本更新页面上选中的卡号，只显示最后四位
            const maskedNumber = "**** **** **** " + cardNumber.slice(-4);
            document.getElementById("selectedCardNumber").textContent = maskedNumber;
            // 更新隐藏的 input 字段值
            document.getElementById("selectedCardNumberInput").value = cardNumber;
        }

        // 使用 JavaScript 处理银行卡号，只显示最后四个字符
        function maskCardNumber(cardNumber) {
            return "**** **** **** " + cardNumber.slice(-4);
        }

        // 页面加载完成后，将所有卡号显示为最后四位
        document.addEventListener("DOMContentLoaded", function () {
            // 初始展示第一个银行卡号
            const firstCardNumberElement = document.getElementById("selectedCardNumber");
            if (firstCardNumberElement) {
                const originalCardNumber = firstCardNumberElement.getAttribute("data-cardnumber");
                firstCardNumberElement.textContent = maskCardNumber(originalCardNumber);
            }

            // 处理所有银行卡号列表
            const cardElements = document.querySelectorAll(".maskedCardNumber");
            cardElements.forEach(function (cardElement) {
                const originalCardNumber = cardElement.getAttribute("data-cardnumber");
                cardElement.textContent = maskCardNumber(originalCardNumber);
            });
        });

        // 切换编辑状态的函数
        function editField(field) {
            document.getElementById(field + "Display").style.display = "none";
            document.getElementById(field + "Edit").style.display = "block";
        }

        // 保存编辑内容并更新隐藏的表单字段值
        function saveField(field) {
            const inputElement = document.getElementById(field + "Input");
            const newValue = inputElement.value;

            // 更新显示的文本内容
            document.getElementById(field + "Text").textContent = newValue;

            // 更新隐藏的表单字段值
            document.getElementById("hidden" + capitalizeFirstLetter(field)).value = newValue;

            // 退出编辑模式
            cancelEdit(field);
        }

        // 取消编辑
        function cancelEdit(field) {
            document.getElementById(field + "Edit").style.display = "none";
            document.getElementById(field + "Display").style.display = "block";
        }

        // 辅助函数：首字母大写
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
    </script>
</head>

<body>
	<div th:replace="fragments :: header"></div>
<form th:action="@{/cartPage}" method="post">
    <input type="submit" value="return to cart"/>
</form>
<h3>Recipient's Information</h3>
<form th:action="@{/submitOrder}" method="post">
    <div>
        <p id="userNameDisplay">
            Username: <span id="userNameText" th:text="${customer.userName}"></span>
            <button type="button" onclick="editField('userName')">Edit</button>
        </p>
        <div id="userNameEdit" style="display: none;">
            <input type="text" id="userNameInput" th:value="${customer.userName}"/>
            <button type="button" onclick="saveField('userName')">Save</button>
            <button type="button" onclick="cancelEdit('userName')">Cancel</button>
        </div>
    </div>
    <div>
        <p id="addressDisplay">
            Address: <span id="addressText" th:text="${customer.address}"></span>
            <button type="button" onclick="editField('address')">Edit</button>
        </p>
        <div id="addressEdit" style="display: none;">
            <input type="text" id="addressInput" th:value="${customer.address}"/>
            <button type="button" onclick="saveField('address')">Save</button>
            <button type="button" onclick="cancelEdit('address')">Cancel</button>
        </div>
    </div>
    <div>
        <p id="phoneNumberDisplay">
            Phone: <span id="phoneNumberText" th:text="${customer.phoneNumber}"></span>
            <button type="button" onclick="editField('phoneNumber')">Edit</button>
        </p>
        <div id="phoneNumberEdit" style="display: none;">
            <input type="text" id="phoneNumberInput" th:value="${customer.phoneNumber}"/>
            <button type="button" onclick="saveField('phoneNumber')">Save</button>
            <button type="button" onclick="cancelEdit('phoneNumber')">Cancel</button>
        </div>
    </div>
    <!-- 隐藏字段，用于存储编辑后的值 -->
    <input type="hidden" id="hiddenUserName" name="recipientName" th:value="${customer.userName}" />
    <input type="hidden" id="hiddenAddress" name="recipientAddress" th:value="${customer.address}" />
    <input type="hidden" id="hiddenPhoneNumber" name="recipientPhone" th:value="${customer.phoneNumber}" />
    <br>
    <h3>Shopping Cart</h3>

    <table>
        <tr>
            <th>Img</th>
            <th>Product</th>
            <th>Price</th>
            <th>Quantity</th>
        </tr>
        <tr th:each="c : ${cart}">
            <td>
                <img th:src="${c.product.coverImagePath}" class="product-image" alt="Product Image"/>
            </td>
            <td th:text="${c.product.name}"></td>
            <td th:text="${c.product.price}"></td>
            <td th:text="${c.productQty}"></td>
        </tr>
        <tr>
            <td colspan="3"><b>Total Price of All Products</b></td>
            <td th:text="${totalPrice}"></td>
        </tr>
    </table>
    <br>
    <!-- 初始展示第一个 PaymentDetail 的银行卡号 -->
    <div th:if="${customer.paymentDetails.size() > 0}">
        <h2>Selected Payment Method</h2>
        <p>Card Number: <span id="selectedCardNumber" th:attr="data-cardnumber=${customer.paymentDetails[0].cardNumber}"></span></p>
    </div>

    <!-- 展示按钮，点击展示所有 PaymentDetail -->
    <button type="button" id="showButton" onclick="showAllPaymentDetails()">Show All Payment Methods</button>

    <!-- 隐藏的所有 PaymentDetail 列表，只展示银行卡号 -->
    <div id="allPaymentDetails" style="display: none;">
        <h2>All Payment Methods</h2>
        <ul>
            <li th:each="paymentDetail : ${customer.paymentDetails}">
                <p>Card Number: <span class="maskedCardNumber" th:attr="data-cardnumber=${paymentDetail.cardNumber}"></span></p>
                <!-- 使用 data-* 属性传递银行卡号 -->
                <button type="button" th:attr="data-cardNumber=${paymentDetail.cardNumber}"
                        onclick="selectPaymentDetail(this.getAttribute('data-cardNumber'))">
                    Select This Card
                </button>
            </li>
        </ul>
    </div>
	<div th:if="${customer.paymentDetails.size() > 0}">
    	<!-- 隐藏字段，用于存储选中的银行卡号 -->
    	<input type="hidden" id="selectedCardNumberInput" name="cardNumber" th:value="${customer.paymentDetails[0].cardNumber}" />
	</div>
    <input type="submit" value="payment"/>
</form>
</body>

</html>